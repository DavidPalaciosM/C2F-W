name: build and release
on:
  pull_request:
    branches:
      - main
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-\w+'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  call_ubuntu_build:
      uses: ./.github/workflows/buildubuntu-latest.yml

  # call_macos_build:
  #     uses: ./.github/workflows/buildmacos-latest.yml

  # call_macos_build_13:
  #     uses: ./.github/workflows/buildmacos-13.yml

  call_windows_build:
      uses: ./.github/workflows/buildwindows.yml

  release:
    # needs: [call_ubuntu_build, call_macos_build, call_macos_build_13, call_windows_build]
    needs: [call_ubuntu_build, call_windows_build]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set Release Tag
      id: set_tag
      run: |
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "RELEASE_TAG=${{ github.sha }}" >> $GITHUB_ENV
        else
          echo "RELEASE_TAG=${{ github.ref }}" >> $GITHUB_ENV
        fi

    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: binaries-*
        path: Cell2Fire
        merge-multiple: true
          
    - name: Binary Windows Zip
      run: |
        cd Cell2Fire
        zip ../Cell2FireW_${{ env.RELEASE_TAG }}-Windows-x86_64-binary.zip Cell2Fire.exe *.dll
        
    - name: Binary Linux Zip
      run: |
        cd Cell2Fire
        zip ../Cell2FireW_${{ env.RELEASE_TAG }}-Linux-x86_64-binary.zip Cell2Fire.Linux.x86_64

    - name: ZipDataInstances
      run: |
        cd data
        zip -r ../Kitral-asc.zip Kitral/*-asc
        zip -r ../Kitral-tif.zip Kitral/*-tif
        zip -r ../CanadianFBP-asc.zip CanadianFBP/*-asc
        zip -r ../CanadianFBP-tif.zip CanadianFBP/*-tif
        zip -r ../ScottAndBurgan-asc.zip ScottAndBurgan/*-asc  
        zip -r ../ScottAndBurgan-tif.zip ScottAndBurgan/*-tif  

    - name: GitArchive
      run: |
        git rm -r data output test
        git add -f Cell2Fire/*
        astash=`git stash create`
        git archive --prefix=C2F/ --output="Cell2FireW_${{ env.RELEASE_TAG }}.zip" $astash

    - name: Create Draft Release for PR
      uses: ncipollo/release-action@v1.14.0
      with:
        artifacts: |
          Cell2FireW_${{ env.RELEASE_TAG }}.zip,
          Cell2FireW_${{ env.RELEASE_TAG }}-Linux-x86_64-binary.zip,
          Cell2FireW_${{ env.RELEASE_TAG }}-Windows-x86_64-binary.zip,
          Kitral-asc.zip,
          Kitral-tif.zip,
          CanadianFBP-asc.zip,
          CanadianFBP-tif.zip,
          ScottAndBurgan-asc.zip,
          ScottAndBurgan-tif.zip
        token: ${{ secrets.GITHUB_TOKEN }}
        draft: true
        tag: ${{ env.RELEASE_TAG }}
        name: "Draft Release #${{ env.RELEASE_TAG }}"
        body: "This is a draft release for #${{ env.RELEASE_TAG }}."
