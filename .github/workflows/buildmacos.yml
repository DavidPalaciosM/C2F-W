name: macos build

on:
  push:
    branches:
      - buildmacos
  workflow_dispatch:
  workflow_call:

permissions:
  contents: write

jobs:
  macos_build:
    runs-on: macos-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Doit
      run: |
        # which gcc-12
        # which brew
        brew install boost eigen llvm libopenmpt gdal
        # find /usr/local -name "Eigen" 2>/dev/null
        # find /usr/local -name "boost" 2>/dev/null
        # find /usr/local -name "llvm" 2>/dev/null
        find /usr/local -name "gdal" 2>/dev/null
        brew --prefix gdal
        export CPATH=/usr/local/opt/gdal/include:$CPATH
        export C_INCLUDE_PATH=/usr/local/opt/gdal/include:$C_INCLUDE_PATH
        export CPLUS_INCLUDE_PATH=/usr/local/opt/gdal/include:$CPLUS_INCLUDE_PATH
        echo "checking directory:"
        cd /usr/local/opt/gdal/include/
        mkdir gdal 
        for item in *; do if [ "$item" != "gdal" ]; then mv "$item" gdal/; fi; done
        ls
        cd gdal 
        ls
        cd /Users/runner/work/C2F-W/C2F-W
        ls
        cd Cell2FireC
        make clean -f makefile.macos-latest
        make -f makefile.macos-latest
        ext=`python3 -c "import platform;print(f'.{platform.system()}.{platform.machine()}')"`
        mv Cell2Fire Cell2Fire$ext
        ls Cell2Fire*

    - name: Upload
      uses: actions/upload-artifact@v3
      with:
        name: binaries
        path: Cell2FireC/Cell2Fire.Darwin.x86_64
